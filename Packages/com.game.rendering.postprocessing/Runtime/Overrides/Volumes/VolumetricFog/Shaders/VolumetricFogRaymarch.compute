// #pragma enable_d3d11_debug_symbols
#pragma only_renderers d3d11 playstation xboxone xboxseries vulkan metal switch

#pragma kernel VolumetricFogRaymarch

#pragma multi_compile _ _FORWARD_PLUS
#pragma multi_compile _ _MAIN_LIGHT_SHADOWS _MAIN_LIGHT_SHADOWS_CASCADE _MAIN_LIGHT_SHADOWS_SCREEN
#pragma multi_compile _ _ADDITIONAL_LIGHTS
#pragma multi_compile _ _ADDITIONAL_LIGHT_SHADOWS
// #pragma multi_compile _ _LIGHT_COOKIES
#if UNITY_VERSION >= 202310
#pragma multi_compile _ PROBE_VOLUMES_L1 PROBE_VOLUMES_L2
#endif

#pragma multi_compile_local _ _MAIN_LIGHT_CONTRIBUTION_DISABLED
#pragma multi_compile_local _ _ADDITIONAL_LIGHTS_CONTRIBUTION_DISABLED
#pragma multi_compile_local _ _PROBE_VOLUME_CONTRIBUTION_ENABLED

#define VOLUMETRIC_FOG_COMPUTE_TILE_SIZE 8

//--------------------------------------------------------------------------------------------------
// Included headers
//--------------------------------------------------------------------------------------------------

#include "Packages/com.unity.render-pipelines.ps5/ShaderLibrary/API/FoveatedRendering_PSSL.hlsl"
#include "Packages/com.kurisu.illusion-render-pipelines/ShaderLibrary/Core.hlsl"
#include "Packages/com.kurisu.illusion-render-pipelines/Shaders/VolumetricFog/VolumetricFog.hlsl"

//--------------------------------------------------------------------------------------------------
// Inputs & outputs
//--------------------------------------------------------------------------------------------------

// Output texture for volumetric fog
RW_TEXTURE2D_X(float4, _VolumetricFogOutput);

//--------------------------------------------------------------------------------------------------
// Implementation
//--------------------------------------------------------------------------------------------------

[numthreads(VOLUMETRIC_FOG_COMPUTE_TILE_SIZE, VOLUMETRIC_FOG_COMPUTE_TILE_SIZE, 1)]
void VolumetricFogRaymarch(uint3 currentCoord : SV_DispatchThreadID,
                          int groupIndex : SV_GroupIndex,
                          uint2 groupThreadId : SV_GroupThreadID,
                          uint2 groupId : SV_GroupID)
{
    // UNITY_XR_ASSIGN_VIEW_INDEX(currentCoord.z);

    // Check bounds
    if (any(currentCoord.xy >= uint2(_ScreenSize.xy / 2)))
        return;
    
    // Calculate UV coordinates for half resolution
    float2 uv = (currentCoord.xy + 0.5) / (_ScreenSize.xy * 0.5);

    half4 fogResult = VolumetricFog(uv, currentCoord.xy);
    
    // Write to output texture
    _VolumetricFogOutput[COORD_TEXTURE2D_X(currentCoord.xy)] = fogResult;
}
